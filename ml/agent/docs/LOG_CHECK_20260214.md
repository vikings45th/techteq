# ログ確認メモ（2026-02-14）

カスタムモデル18特徴量デプロイ後、Web でルート生成を試した際の Cloud Run ログ確認結果。

## 1. Ranker タイムアウト（要対応済み）

- **現象**: Agent が Ranker を呼んだ際に `ReadTimeout` が発生。
- **ログ**: `[Ranker Timeout] request_id=... timeout_sec=10.0 err=ReadTimeout('')`  
  `[Ranker Error] request_id=... err=ReadTimeout('')`
- **原因**: Ranker が Vertex AI を呼ぶと、コールドスタート含め 10 秒を超えることがあり、Agent の `RANKER_TIMEOUT_SEC=10` で切れていた。
- **結果**: そのリクエストでは **fallback_ranking**（ヒューリスティック）でランク付けされ、見た目は 200 OK で返っているが、**Vertex のスコアは使われていない**。
- **対応**: GitHub Actions の `deploy-agent.yml` で `RANKER_TIMEOUT_SEC=20` に変更。Agent を再デプロイすれば、多くのケースで Ranker（Vertex）がタイムアウトせず使われる想定。

## 2. Vertex LLM タイトル・要約のバリデーションエラー（要観測）

- **現象**: `TitleDescriptionResponse` のバリデーションエラー。LLM が空文字 `''` を返している。
- **ログ**: `[Vertex LLM Title+Summary Invalid] err=1 validation error for TitleDescriptionResponse ... Input should be a valid dictionary or instance of TitleDescriptionResponse [type=model_type, input_value='', input_type=str]`
- **結果**: タイトル・要約はフォールバック等で補われ、ルート生成自体は 200 で返っている。継続して発生するか、特定条件かは要観測。

## 3. その他

- **Places API**: キーワードで 400 が出たあと "retrying without keyword" で成功している。既存のリトライで処理済み。
- **Ranker**: `POST /rank HTTP/1.1 200 OK` は出ているが、Agent 側が先にタイムアウトしていたため、そのリクエストではフォールバックになっていた可能性が高い。

## 次のアクション

1. **Agent の再デプロイ**: `RANKER_TIMEOUT_SEC=20` を反映するため、`deploy-agent.yml` を push して Agent をデプロイする。
2. 再度ルート生成を試し、Agent ログで `[Ranker Latency]` が出力され、`ranker_status=ok` になっているか確認する。
3. Vertex LLM の空レスポンスが続くようなら、プロンプトやレスポンスパース処理の見直しを検討する。
