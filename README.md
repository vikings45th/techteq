# firstdown

æ•£æ­©ãƒ«ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸæœ€é©ãªæ•£æ­©ã‚³ãƒ¼ã‚¹ã‚’ææ¡ˆã—ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ](#ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ )
- [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [APIä»•æ§˜](#apiä»•æ§˜)
- [ãƒ‡ãƒ—ãƒ­ã‚¤](#ãƒ‡ãƒ—ãƒ­ã‚¤)
- [é–‹ç™ºã‚¬ã‚¤ãƒ‰](#é–‹ç™ºã‚¬ã‚¤ãƒ‰)
- [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)
- [ãƒ©ã‚¤ã‚»ãƒ³ã‚¹](#ãƒ©ã‚¤ã‚»ãƒ³ã‚¹)
- [ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³](#ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³)
- [ãƒªãƒ³ã‚¯](#ãƒªãƒ³ã‚¯)

## æ¦‚è¦

firstdownã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã«å¿œã˜ã¦æœ€é©ãªæ•£æ­©ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

### ä¸»ãªæ©Ÿèƒ½

- **æ°—åˆ†ãƒ»ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸãƒ«ãƒ¼ãƒˆç”Ÿæˆ**: 4ãƒ¢ãƒ¼ãƒ‰ï¼ˆexercise, think, refresh, natureï¼‰ã«åˆã‚ã›ã¦ãƒ«ãƒ¼ãƒˆã‚’ææ¡ˆ
- **AIã«ã‚ˆã‚‹ç´¹ä»‹æ–‡ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ**: Vertex AI + æ§‹é€ åŒ–å‡ºåŠ›ã§å®‰å®šã—ãŸæ–‡é¢ã‚’ç”Ÿæˆ
- **ã‚¹ãƒãƒƒãƒˆæ¤œç´¢**: äºŒæ®µéšæ¤œç´¢ï¼ˆç©´å ´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ ãƒ†ãƒ¼ãƒã«åˆã£ãŸå ´æ‰€ã‚¿ã‚¤ãƒ—ï¼‰+ ãƒ«ãƒ¼ãƒˆè¿‘å‚ãƒ•ã‚£ãƒ«ã‚¿
- **ãƒ«ãƒ¼ãƒˆæœ€é©åŒ–**: æ©Ÿæ¢°å­¦ç¿’ã«ã‚ˆã‚‹ãƒ«ãƒ¼ãƒˆå“è³ªè©•ä¾¡ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆVertex AI Endpointæ¨è«–ï¼‰
- **ãƒ«ãƒ¼ãƒˆå½¢çŠ¶ã®å¤šæ§˜åŒ–**: ç›´ç·š/å††/è›‡è¡Œãªã©è¤‡æ•°å½¢çŠ¶ã®å€™è£œã‚’ç”Ÿæˆ
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**: 4ç¨®é¡ï¼ˆRoutes/Ranker/Vertex å¤±æ•—ãƒ»ç„¡åŠ¹ãƒ«ãƒ¼ãƒˆæ¤œå‡ºï¼‰ã«å¯¾å¿œã€‚ç°¡æ˜“ãƒ«ãƒ¼ãƒˆã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡ã§å¿œç­”ã—ã€`meta.fallback_details` ã§ç†ç”±ã‚’è¿”å´

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Nuxt.js 4, Vue 3, Nuxt UI
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: FastAPI (Python)
- **ML/AI**: Vertex AI (Gemini), ãƒ«ãƒ¼ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«
- **å¤–éƒ¨API**: Google Maps Platform (Routes API, Places API)
- **ã‚¤ãƒ³ãƒ•ãƒ©**: Google Cloud Run, BigQueryã€‚GCP ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã¯ Terraformï¼ˆ[infra/](infra/README.md)ï¼‰ã§ç®¡ç†
- **CI/CD**: GitHub Actions

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web App   â”‚ (Nuxt.js)
â”‚  (Frontend) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent API     â”‚ (FastAPI)
â”‚  (Orchestrator) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â–º Maps Routes API â”€â”€â–º ãƒ«ãƒ¼ãƒˆå€™è£œã®è“„ç©çš„ç”Ÿæˆï¼ˆå½¢çŠ¶å¤šæ§˜åŒ–ãƒ»è·é›¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ»çŸ­è·é›¢è£œæ­£ãƒ»å†è©¦è¡Œãƒ»é–¾å€¤ã§æ—©æœŸçµ‚äº†ï¼‰
       â”œâ”€â”€â–º Places API â”€â”€â”€â”€â”€â”€â–º ã‚¹ãƒãƒƒãƒˆæ¤œç´¢
       â”œâ”€â”€â–º Ranker API â”€â”€â”€â”€â”€â”€â–º ãƒ«ãƒ¼ãƒˆè©•ä¾¡
       â”‚                         â””â”€â”€â–º Vertex AI Endpointï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨æ¨è«–ï¼‰
       â”œâ”€â”€â–º Vertex AI â”€â”€â”€â”€â”€â”€â”€â–º ç´¹ä»‹æ–‡ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
       â””â”€â”€â–º BigQuery â”€â”€â”€â”€â”€â”€â”€â”€â–º ãƒ­ã‚°ãƒ»åˆ†æ
```

### ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆ

1. **Web App** (`web/`): ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNuxt ã‚µãƒ¼ãƒãƒ¼API: ãƒ«ãƒ¼ãƒˆç”Ÿæˆãƒ—ãƒ­ã‚­ã‚·ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ç”¨AIææ¡ˆï¼‰
2. **Agent API** (`ml/agent/`): ãƒ«ãƒ¼ãƒˆç”Ÿæˆã‚’çµ±æ‹¬ã™ã‚‹ãƒ¡ã‚¤ãƒ³API
3. **Ranker API** (`ml/ranker/`): ãƒ«ãƒ¼ãƒˆå€™è£œã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
firstdown/
â”œâ”€â”€ .github/
â”‚   â””â”€â”€ workflows/          # CI/CD
â”‚       â”œâ”€â”€ deploy-agent.yml
â”‚       â””â”€â”€ deploy-ranker.yml
â”œâ”€â”€ infra/                  # ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆIaCï¼‰
â”‚   â”œâ”€â”€ README.md           # æ–¹é‡ãƒ»ä½¿ã„æ–¹ãƒ»GCPã‚µãƒ¼ãƒ“ã‚¹ã¨IaCã®å¯¾å¿œ
â”‚   â””â”€â”€ terraform/          # Terraformï¼ˆAPIæœ‰åŠ¹åŒ–ã€ARã€BQã€IAMã€Cloud Runå®šç¾©ï¼‰
â”œâ”€â”€ ml/
â”‚   â”œâ”€â”€ agent/              # ãƒ«ãƒ¼ãƒˆç”ŸæˆAPIï¼ˆFastAPIï¼‰
â”‚   â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py     # ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ graph.py    # ãƒ«ãƒ¼ãƒˆç”Ÿæˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆLangGraphï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.py
â”‚   â”‚   â”‚   â”œâ”€â”€ settings.py
â”‚   â”‚   â”‚   â”œâ”€â”€ utils.py
â”‚   â”‚   â”‚   â”œâ”€â”€ prompts/    # Vertex AIç”¨Jinja
â”‚   â”‚   â”‚   â””â”€â”€ services/   # maps_routes_client, places_client, ranker_client,
â”‚   â”‚   â”‚                   # vertex_llm, feature_calc, fallback, polyline, bq_writer, http_client
â”‚   â”‚   â”œâ”€â”€ bq/             # BigQueryç”¨DDLãƒ»ãƒ“ãƒ¥ãƒ¼ï¼ˆroute_*.sql, training_view.sql ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ test_generate_api.sh
â”‚   â”œâ”€â”€ ranker/             # ãƒ«ãƒ¼ãƒˆè©•ä¾¡APIï¼ˆFastAPIï¼‰
â”‚   â”‚   â”œâ”€â”€ app/            # main.py, model_scoring.py, bq_logger.py, schemas.py, settings.py
â”‚   â”‚   â”œâ”€â”€ bq/             # rank_result_shadow.sql
â”‚   â”‚   â”œâ”€â”€ training/       # train_xgb.pyï¼ˆå­¦ç¿’ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼‰
â”‚   â”‚   â”œâ”€â”€ artifacts/      # å­¦ç¿’æˆæœç‰©å‡ºåŠ›å…ˆ
â”‚   â”‚   â”œâ”€â”€ models/         # æ¨è«–ç”¨æˆæœç‰©ï¼ˆmodel.xgb.json ç­‰ï¼‰
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”‚   â”œâ”€â”€ README.md
â”‚   â”‚   â””â”€â”€ test_ranker.py
â”‚   â””â”€â”€ vertex/
â”‚       â””â”€â”€ predictor/      # Vertex AI ã‚«ã‚¹ã‚¿ãƒ æ¨è«–ã‚³ãƒ³ãƒ†ãƒŠï¼ˆRankerç”¨ï¼‰
â”‚           â”œâ”€â”€ app.py
â”‚           â”œâ”€â”€ Dockerfile
â”‚           â””â”€â”€ requirements.txt
â””â”€â”€ web/                    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNuxt 4ï¼‰
    â”œâ”€â”€ app/                # pages/, layouts/, composables/, types/, app.vue, app.config.ts
    â”œâ”€â”€ server/api/         # fetch-ai, route-feedback, gemini
    â”œâ”€â”€ assets/
    â”œâ”€â”€ public/
    â”œâ”€â”€ nuxt.config.ts
    â”œâ”€â”€ Dockerfile
    â”œâ”€â”€ package.json
    â””â”€â”€ README.md
```

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- Python 3.11+
- Node.js 18+
- Docker (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
- Google Cloud Platform ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
- Google Maps Platform API Key

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ

#### 1. Agent API ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
cd ml/agent

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
export MAPS_API_KEY="your-api-key"
export VERTEX_PROJECT="your-project-id"
export VERTEX_LOCATION="asia-northeast1"
export RANKER_URL="http://localhost:8080"

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
uvicorn app.main:app --reload --port 8000
```

è©³ç´°ã¯ [ml/agent/README.md](./ml/agent/README.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### 2. Ranker API ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
cd ml/ranker

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install -r requirements.txt

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
uvicorn app.main:app --reload --port 8080
```

è©³ç´°ã¯ [ml/ranker/README.md](./ml/ranker/README.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### 3. Web App ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
cd web

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
npm run dev
```

è©³ç´°ã¯ [web/README.md](./web/README.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### ç’°å¢ƒå¤‰æ•°

å„ã‚µãƒ¼ãƒ“ã‚¹ã®ç’°å¢ƒå¤‰æ•°ã«ã¤ã„ã¦ã¯ã€å„ã‚µãƒ¼ãƒ“ã‚¹ã®READMEã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- [Agent API ç’°å¢ƒå¤‰æ•°](./ml/agent/README.md#ç’°å¢ƒå¤‰æ•°)
- [Ranker API ç’°å¢ƒå¤‰æ•°](./ml/ranker/README.md)

## ä½¿ç”¨æ–¹æ³•

### APIãƒ†ã‚¹ãƒˆ

Agent APIã®ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€4ã¤ã®ãƒ†ãƒ¼ãƒã§ãƒ«ãƒ¼ãƒˆç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚

```bash
cd ml/agent

# ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export AGENT_URL="http://localhost:8000"
# ã¾ãŸã¯æœ¬ç•ªç’°å¢ƒ
export AGENT_URL="https://agent-203786374782.asia-northeast1.run.app"

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
bash test_generate_api.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
- 4ã¤ã®ãƒ†ãƒ¼ãƒï¼ˆexercise, think, refresh, natureï¼‰ã§ãƒ†ã‚¹ãƒˆ
- ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹åœ°ç‚¹ã¨è·é›¢ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- çµæœã‚’JSONå½¢å¼ã§å‡ºåŠ›

### Web App ã®ä½¿ç”¨

1. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•: `cd web && npm run dev`
2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ `http://localhost:3000` ã«ã‚¢ã‚¯ã‚»ã‚¹
3. ãƒ«ãƒ¼ãƒˆç”Ÿæˆãƒ•ã‚©ãƒ¼ãƒ ã§ä»¥ä¸‹ã‚’å…¥åŠ›ï¼š
   - ãƒ†ãƒ¼ãƒé¸æŠ
   - é–‹å§‹åœ°ç‚¹ï¼ˆç·¯åº¦ãƒ»çµŒåº¦ï¼‰
   - è·é›¢ï¼ˆkmï¼‰
   - å¾€å¾©ãƒ«ãƒ¼ãƒˆã®æœ‰ç„¡

## APIä»•æ§˜

### Agent API

#### `POST /route/generate`

ãƒ«ãƒ¼ãƒˆç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ

**æ³¨æ„:**
- `round_trip: true` ã®å ´åˆã¯ `end_location` ã‚’ç„¡è¦–ã—ã¾ã™ï¼ˆé€ä¿¡ã¯å¯ï¼‰
- `round_trip: false` ã®å ´åˆã¯ `end_location` ãŒå¿…é ˆã§ã™
- ç‰‡é“ã§ç›´ç·šè·é›¢ãŒçŸ­ã„å ´åˆã¯ã€ç›®æ¨™è·é›¢ã«åˆã‚ã›ã¦å›ã‚Šé“ã—ã¾ã™
- `nav_waypoints` ã¯ polyline ç”±æ¥ã®ä»£è¡¨ç‚¹ã§æ§‹æˆã•ã‚Œã€å‘¨å›ãƒ«ãƒ¼ãƒˆã§ã¯å§‹çµ‚ç‚¹ãŒä¸€è‡´ã—ã¾ã™

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆå‘¨å›ï¼‰:**
```json
{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "theme": "exercise",
  "distance_km": 3.0,
  "start_location": {
    "lat": 35.6812,
    "lng": 139.7671
  },
  "end_location": {
    "lat": 35.6896,
    "lng": 139.6917
  },
  "round_trip": true,
  "debug": false
}
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹ï¼ˆç‰‡é“ï¼‰:**
```json
{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "theme": "refresh",
  "distance_km": 3.0,
  "start_location": {
    "lat": 35.6812,
    "lng": 139.7671
  },
  "end_location": {
    "lat": 35.6896,
    "lng": 139.6917
  },
  "round_trip": false,
  "debug": false
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¾‹:**
```json
{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "route": {
    "route_id": "e3b0c442-98fc-1c14-9afb-3c2e4f7a1d0b",
    "polyline": "encoded_polyline_string",
    "distance_km": 3.2,
    "duration_min": 45,
    "title": "æœ¨é™°ã‚’æŠœã‘ã‚‹å·æ²¿ã„ã‚¦ã‚©ãƒ¼ã‚¯",
    "summary": "é‹å‹•ã«é©ã—ãŸæ•£æ­©ãƒ«ãƒ¼ãƒˆã§ã™...",
    "nav_waypoints": [
      {"lat": 35.6812, "lng": 139.7671},
      {"lat": 35.6840, "lng": 139.7702}
    ],
    "spots": [
      {
        "name": "ä»£ã€…æœ¨å…¬åœ’",
        "type": "å…¬åœ’",
        "lat": 35.6717,
        "lng": 139.6949
      }
    ]
  },
  "meta": {
    "fallback_used": false,
    "tools_used": ["maps_routes", "places", "ranker", "vertex_llm"],
    "route_quality": {
      "is_fallback": false,
      "distance_match": 0.95,
      "distance_error_km": 0.2,
      "quality_score": 0.9
    }
  }
}
```

#### `POST /route/feedback`

ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹:**
```json
{
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "route_id": "e3b0c442-98fc-1c14-9afb-3c2e4f7a1d0b",
  "rating": 5
}
```

#### `GET /health`

ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

è©³ç´°ã¯ [ml/agent/README.md](./ml/agent/README.md#apiä»•æ§˜) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Ranker API

è©³ç´°ã¯ [ml/ranker/README.md](./ml/ranker/README.md#apiä»•æ§˜) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ãƒ‡ãƒ—ãƒ­ã‚¤

### Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤

Agent API ã¨ Ranker API ã¯ GitHub Actions çµŒç”±ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚Web Appï¼ˆwebï¼‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¾ãŸã¯æ‰‹å‹•ã§å®Ÿæ–½ã—ã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚GCP ãƒªã‚½ãƒ¼ã‚¹ã®å®šç¾©ã¯ [infra/README.md](infra/README.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

#### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼

- **Agent API**: `ml/agent/**` ã¸ã®å¤‰æ›´ã‚’æ¤œçŸ¥
- **Ranker API**: `ml/ranker/**` ã¸ã®å¤‰æ›´ã‚’æ¤œçŸ¥

#### ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š

- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: `asia-northeast1`
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 300ç§’ï¼ˆAgent APIï¼‰
- **ãƒ¡ãƒ¢ãƒª**: 2Giï¼ˆAgent APIï¼‰
- **CPU**: 2ï¼ˆAgent APIï¼‰

è©³ç´°ã¯ `.github/workflows/` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### å¿…è¦ãªGCPãƒªã‚½ãƒ¼ã‚¹

API æœ‰åŠ¹åŒ–ãƒ»Artifact Registryãƒ»BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ»ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ IAM ã¯ [infra/terraform/](infra/README.md) ã§ Terraform å®šç¾©æ¸ˆã¿ã€‚Cloud Run ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ GitHub Actions ã®ã¾ã¾ã€‚

1. **Cloud Run**: ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè¡Œç’°å¢ƒ
2. **Artifact Registry**: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜
3. **BigQuery**: ãƒ­ã‚°ãƒ»åˆ†æãƒ‡ãƒ¼ã‚¿ä¿å­˜ã€‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ `firstdown_mvp` ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»å€™è£œãƒ»ææ¡ˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»ãƒ©ãƒ³ã‚¯çµæœç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨å­¦ç¿’ç”¨ãƒ“ãƒ¥ãƒ¼ã‚’é…ç½®ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ç”¨é€”ã¯ [ml/README.md](./ml/README.md#bigquery-ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ç”¨é€”) ãŠã‚ˆã³ [ml/agent/README.md](./ml/agent/README.md#bigquery-ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã¨ç”¨é€”) ã‚’å‚ç…§ã€‚
4. **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ**: Vertex AI èªè¨¼ç”¨

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

GitHub Secretsã«ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

- `GCP_SA_KEY`: GCPã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ï¼ˆJSONï¼‰
- `MAPS_API_KEY`: Google Maps Platform API Key

## é–‹ç™ºã‚¬ã‚¤ãƒ‰

### ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„

- **Python**: PEP 8æº–æ‹ ã€å‹ãƒ’ãƒ³ãƒˆä½¿ç”¨
- **TypeScript/JavaScript**: ESLintæº–æ‹ 
- **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: æ˜ç¢ºã§ç°¡æ½”ã«

### ãƒ†ã‚¹ãƒˆ

#### Agent API ãƒ†ã‚¹ãƒˆ

```bash
cd ml/agent
bash test_generate_api.sh
```

#### Ranker API ãƒ†ã‚¹ãƒˆ

```bash
cd ml/ranker
python test_ranker.py
```

### ãƒ­ã‚°

ã™ã¹ã¦ã®ãƒ­ã‚°ã«`request_id`ã‚’å«ã‚ã‚‹ã“ã¨ã§ã€1ã¤ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡å¯èƒ½ã§ã™ã€‚

**ãƒ­ã‚°å½¢å¼:**
```
[Component] request_id={request_id} message...
```

**Cloud Loggingã§ã®æ¤œç´¢ä¾‹:**
```
resource.type="cloud_run_revision"
jsonPayload.request_id="your-request-id"
```

é‹ç”¨ãƒ­ã‚°ã¯ Cloud Logging ã«ä¿å­˜ã€‚é•·æœŸä¿å­˜ã™ã‚‹å ´åˆã¯ã€ãƒ­ã‚°ã‚·ãƒ³ã‚¯ã§ GCS ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã€ãƒã‚±ãƒƒãƒˆã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã§ Nearline/Coldline ã«ç§»ã™ã¨æ–™é‡‘ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹ï¼ˆå¿…è¦ã«ãªã£ãŸã‚‰ Terraform ã§ã‚·ãƒ³ã‚¯ãƒ»ãƒã‚±ãƒƒãƒˆã‚’è¿½åŠ å¯ï¼‰ã€‚

### ä¸»è¦ãªãƒ­ã‚°ã‚¿ã‚°

- `[Routes API Error]`: Maps Routes APIã‚¨ãƒ©ãƒ¼
- `[Places]`: Places APIæˆåŠŸ
- `[Places Error]`: Places APIã‚¨ãƒ©ãƒ¼
- `[Ranker Timeout]`: Rankerã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- `[Ranker Error]`: Rankerã‚¨ãƒ©ãƒ¼
- `[Vertex LLM Error]`: Vertex AIã‚¨ãƒ©ãƒ¼
- `[Fallback Polyline Error]`: Fallbackå‡¦ç†ã‚¨ãƒ©ãƒ¼

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. API Key ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `MAPS_API_KEY is not configured` ã‚¨ãƒ©ãƒ¼

**è§£æ±ºæ–¹æ³•**:
- ç’°å¢ƒå¤‰æ•° `MAPS_API_KEY` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- Google Cloud Consoleã§APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- API Keyã®åˆ¶é™è¨­å®šã‚’ç¢ºèª

#### 2. Vertex AI èªè¨¼ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: `Permission denied` ã‚¨ãƒ©ãƒ¼

**è§£æ±ºæ–¹æ³•**:
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã« `aiplatform.endpoints.predict` æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª
- `VERTEX_PROJECT` ã¨ `VERTEX_LOCATION` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

#### 3. Ranker API ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**ç—‡çŠ¶**: `Ranker Timeout` ãƒ­ã‚°

**è§£æ±ºæ–¹æ³•**:
- Ranker APIãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
- `RANKER_URL` ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- `RANKER_TIMEOUT_SEC` ã‚’å¢—ã‚„ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 10ç§’ï¼‰

#### 4. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹

**ç—‡çŠ¶**: `fallback_used: true` ãŒè¿”ã•ã‚Œã‚‹

**åŸå› **ï¼ˆç†ç”±ã‚³ãƒ¼ãƒ‰ï¼‰:
- `maps_routes_failed`: Maps Routes API ã®å¤±æ•—
- `ranker_failed`: Ranker API ã®å¤±æ•—ãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
- `vertex_llm_failed`: Vertex AI ã®å¤±æ•—ï¼ˆç´¹ä»‹æ–‡ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å·®ã—æ›¿ãˆï¼‰
- `invalid_route_detected`: é¸æŠã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆãŒç„¡åŠ¹ï¼ˆè·é›¢æ¥µå°ã‚„ polyline ä¸æ­£ï¼‰ã ã£ãŸãŸã‚ãƒ€ãƒŸãƒ¼ã«å·®ã—æ›¿ãˆ

**ç¢ºèªæ–¹æ³•**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® `meta.fallback_reason` ãŠã‚ˆã³ `meta.fallback_details` ã§ç†ç”±ã‚’ç¢ºèª
- ãƒ­ã‚°ã§ `fallback_reason` ã‚’æ¤œç´¢
- å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ

### ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰

APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ `debug: true` ã‚’è¨­å®šã™ã‚‹ã¨ã€è¿½åŠ ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒè¿”ã•ã‚Œã¾ã™ï¼š

```json
{
  "request_id": "...",
  "theme": "exercise",
  "distance_km": 3.0,
  "start_location": {...},
  "round_trip": true,
  "debug": true
}
```

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š
- `meta.plan`: å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒªã‚¹ãƒˆ
- `meta.retry_policy`: ãƒªãƒˆãƒ©ã‚¤ãƒãƒªã‚·ãƒ¼
- `meta.debug`: è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

[ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ±ã‚’è¨˜è¼‰]

## ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

[ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’è¨˜è¼‰]

## ãƒªãƒ³ã‚¯

- [ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆIaCï¼‰README](./infra/README.md)
- [Agent API README](./ml/agent/README.md)
- [Ranker API README](./ml/ranker/README.md)
- [Web App README](./web/README.md)
- [ML Services README](./ml/README.md)
