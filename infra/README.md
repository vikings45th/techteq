# ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆIaCï¼‰

Google Cloud ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ Terraform ã§ã‚³ãƒ¼ãƒ‰ç®¡ç†ã—ã¾ã™ã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªå†…ã® `infra/terraform/` ã§å®šç¾©ã—ã€é©ç”¨ã¯æ‰‹å…ƒã¾ãŸã¯ CI ã‹ã‚‰è¡Œã„ã¾ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [æ–¹é‡](#æ–¹é‡)
- [å‰æ](#å‰æ)
- [æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã§åˆ©ç”¨ã™ã‚‹ Google Cloud ã‚µãƒ¼ãƒ“ã‚¹ã¨ IaC ã®å¯¾å¿œ](#æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã§åˆ©ç”¨ã™ã‚‹-google-cloud-ã‚µãƒ¼ãƒ“ã‚¹ã¨-iac-ã®å¯¾å¿œ)
- [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£)
- [æ§‹æˆ](#æ§‹æˆ)
- [ä½¿ã„æ–¹](#ä½¿ã„æ–¹)
- [ç®¡ç†å¯¾è±¡ã¨æœªç®¡ç†](#ç®¡ç†å¯¾è±¡ã¨æœªç®¡ç†)
- [å¤‰æ•°ã®æ‰±ã„ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ©ç”¨æ™‚ï¼‰](#å¤‰æ•°ã®æ‰±ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ©ç”¨æ™‚)
- [Cloud Run ã®å®šç¾©ã¨ãƒ‡ãƒ—ãƒ­ã‚¤](#cloud-run-ã®å®šç¾©ã¨ãƒ‡ãƒ—ãƒ­ã‚¤)

## æ–¹é‡

- **Terraform**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã€ŒåœŸå°ã€ã«åŠ ãˆã€**Cloud Run ã®è¨­å®šã¯ Terraform ã§å®šç¾©ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰**ã¨ã—ã¦æŒã¤ã€‚å®Ÿç’°å¢ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆtimeout / memory / cpu / env ãªã©ï¼‰ã‚’ `cloud_run.tf` ã«åæ˜ æ¸ˆã¿ã€‚
- **Cloud Run ã®ãƒ‡ãƒ—ãƒ­ã‚¤**: **å¾“æ¥ã©ãŠã‚Š GitHub Actionsï¼ˆ`gcloud run deploy`ï¼‰ã§å®Ÿæ–½**ã€‚Terraform ã¯ã€Œè¨­å®šã®å‚ç…§ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€ã¨ã—ã¦ä½¿ã„ã€å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ CI ã®ã¾ã¾ã€‚
- **å¤‰æ•°ã®åˆ‡ã‚Šåˆ†ã‘**: **å¤‰æ›´ãŒå¿…è¦ãªã‚‚ã®**ï¼ˆã‚µãƒ¼ãƒ“ã‚¹åãƒ»ã‚­ãƒ¼ãƒ»URLãƒ»ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ IDãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³åãªã©ï¼‰ã¯å¤‰æ•°ï¼ˆ`variables.tf` + `terraform.tfvars`ï¼‰ã§å¤–å‡ºã—ã—ã€**ãã®éƒ¨åˆ†ã ã‘å¤‰ãˆã‚Œã°ä»–ç’°å¢ƒã§ã‚‚ä½¿ãˆã‚‹**ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚**æ™®éçš„ãªã‚‚ã®**ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã® timeout / memory / CPU / ã‚¹ã‚±ãƒ¼ãƒ«ã€IAM ãƒ­ãƒ¼ãƒ«ãƒ»ãƒãƒªã‚·ãƒ¼ãªã©ï¼‰ã¯ã‚³ãƒ¼ãƒ‰ã«ãã®ã¾ã¾æ›¸ã„ã¦ã‚ã‚Šã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æµç”¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ãã®ã¾ã¾åˆ©ç”¨ã§ãã‚‹ã€‚
- **çŠ¶æ…‹ãƒ•ã‚¡ã‚¤ãƒ«**: æœ¬ç•ªç”¨ã¯ GCS ãƒã‚±ãƒƒãƒˆã«ä¿å­˜ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼ˆ`backend "gcs"`ï¼‰ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã§è©¦ã™å ´åˆã¯ `backend "local"` ã¾ãŸã¯æœªæŒ‡å®šã§å¯ã€‚

## å‰æ

- åˆ©ç”¨ã™ã‚‹ GCP ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯æ—¢ã«å­˜åœ¨ã™ã‚‹æƒ³å®šï¼ˆ`firstdown-482704` ãªã©ï¼‰ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã®ä½œæˆã‚‚ Terraform ã§è¡Œã†å ´åˆã¯ `google_project` ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
- Terraform ã‚’å®Ÿè¡Œã™ã‚‹ identityï¼ˆæ‰‹å…ƒã® gcloud ã¾ãŸã¯ CI ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰ã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹é©åˆ‡ãªæ¨©é™ï¼ˆç·¨é›†è€…ã¾ãŸã¯å¿…è¦ãªæœ€å°ãƒ­ãƒ¼ãƒ«ï¼‰ãŒã‚ã‚‹ã“ã¨ã€‚

## æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã§åˆ©ç”¨ã™ã‚‹ Google Cloud ã‚µãƒ¼ãƒ“ã‚¹ã¨ IaC ã®å¯¾å¿œ

firstdown ã§åˆ©ç”¨ã—ã¦ã„ã‚‹ Google Cloud ã®ã‚µãƒ¼ãƒ“ã‚¹ä¸€è¦§ã¨ã€ã“ã® IaCï¼ˆTerraformï¼‰ã§ç®¡ç†ã™ã‚‹ã‹ã©ã†ã‹ã®å¯¾å¿œã§ã™ã€‚

| Google Cloud ã‚µãƒ¼ãƒ“ã‚¹ | æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã§ã®ç”¨é€” | IaC ã§ç®¡ç† | å‚™è€ƒ |
|------------------------|-------------------|------------|------|
| **Cloud Run** | Agent / Ranker / Web ã®å®Ÿè¡ŒåŸºç›¤ | å®šç¾©ã®ã¿ï¼ˆä»»æ„ã§ apply å¯ï¼‰ | agentãƒ»ranker ã¯ `cloud_run.tf` ã«å®šç¾©ã€‚web ã¯æœªå®šç¾©ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ GitHub Actions ç­‰ã§å®Ÿæ–½ |
| **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ï¼ˆGlobal HTTP(S) LBï¼‰** | ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆtekuteq.com ç­‰ï¼‰ã§ Web ã‚’å…¬é–‹ | ã—ãªã„ | å®Ÿç’°å¢ƒ: URL ãƒãƒƒãƒ— `tekuteq-external-alb`ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ `tekuteq-backend-web`ã€NEGï¼ˆCloud Run **web**ï¼‰ã€‚LBâ†’NEGâ†’web ã§ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³å…¬é–‹ã€‚IaC åŒ–ã™ã‚‹å ´åˆã¯ Terraform ã§è¿½åŠ å¯ |
| **Cloud Armor** | LB ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ»WAF | ã—ãªã„ | å®Ÿç’°å¢ƒã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ãƒãƒªã‚·ãƒ¼ç´ã¥ã‘ï¼ˆä¾‹: 500 req/60ç§’/IPï¼‰ã€‚IaC åŒ–ã™ã‚‹å ´åˆã¯ Terraform ã§è¿½åŠ å¯ |
| **Cloud CDN** | LB çµŒç”±ã®é™çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ã—ãªã„ | å®Ÿç’°å¢ƒã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã« CDN æœ‰åŠ¹ï¼ˆCACHE_ALL_STATIC ç­‰ï¼‰ã€‚IaC åŒ–ã™ã‚‹å ´åˆã¯ Terraform ã§è¿½åŠ å¯ |
| **Artifact Registry** | Agent / Ranker ã® Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜ | âœ… ã™ã‚‹ | ãƒªãƒã‚¸ãƒˆãƒª `agent-repo`, `ranker-repo` ã‚’ Terraform ã§ä½œæˆ |
| **BigQuery** | ãƒ­ã‚°ãƒ»åˆ†æï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»å€™è£œãƒ»ææ¡ˆãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ»ãƒ©ãƒ³ã‚¯çµæœï¼‰ | âœ… ã™ã‚‹ | ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ Terraform ã§ä½œæˆã€‚ãƒ†ãƒ¼ãƒ–ãƒ« DDL ã¯ `ml/agent/bq/` ç­‰ã§åˆ¥ç®¡ç† |
| **Vertex AIï¼ˆLLMï¼‰** | ç´¹ä»‹æ–‡ãƒ»ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆGemini ç­‰ã®ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ LLMï¼‰ | API æœ‰åŠ¹åŒ–ã®ã¿ | ãƒ¢ãƒ‡ãƒ«ã¯ API çµŒç”±ã§åˆ©ç”¨ã™ã‚‹ã ã‘ã€‚Terraform ã§ãƒªã‚½ãƒ¼ã‚¹ä½œæˆã¯ä¸è¦ |
| **Vertex AIï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ï¼‰** | ãƒ©ãƒ³ã‚«ãƒ¼ç”¨ã‚«ã‚¹ã‚¿ãƒ æ¨è«–ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆXGBoost ç­‰ï¼‰ | ã—ãªã„ | ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯æœªç®¡ç†ï¼ˆå®Ÿç’°å¢ƒã®ä¾‹: `ranker-xgb-endpoint-20260211-0201`ï¼‰ã€‚å¿…è¦ãªã‚‰åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§è¿½åŠ å¯ |
| **Google Maps Platform**ï¼ˆRoutes API, Places API, Maps JavaScript APIï¼‰ | ãƒ«ãƒ¼ãƒˆç”Ÿæˆãƒ»ã‚¹ãƒãƒƒãƒˆæ¤œç´¢ãƒ»åœ°å›³è¡¨ç¤º | API æœ‰åŠ¹åŒ–ã®ã¿ï¼ˆmaps-backendï¼‰ | API ã‚­ãƒ¼ã¯æ‰‹å‹•ã¾ãŸã¯ CI ã®ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã€‚Terraform ã§ã¯æŒãŸãªã„ |
| **IAMï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒ­ãƒ¼ãƒ«ï¼‰** | Agent Cloud Run ã®å®Ÿè¡Œ IDã€Vertex AIãƒ»BigQuery ã¸ã®æ¨©é™ä»˜ä¸ | âœ… ã™ã‚‹ | Agent ç”¨ SA ã®ä½œæˆã¾ãŸã¯æ—¢å­˜å‚ç…§ï¼‹ãƒ­ãƒ¼ãƒ«ä»˜ä¸ã‚’ Terraform ã§å®Ÿæ–½ï¼ˆ`iam.tf`ï¼‰ |
| **Cloud Logging** | Cloud Run ã®æ¨™æº–å‡ºåŠ›ãƒ»ã‚¢ãƒ—ãƒªãƒ­ã‚°ã®åé›†ãƒ»æ¤œç´¢ | ã—ãªã„ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æœ‰åŠ¹ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆãƒ»ã‚·ãƒ³ã‚¯ãƒ»é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿ç­‰ã¯æœªå®šç¾©ã€‚é•·æœŸä¿å­˜ã¯ GCS ã‚·ãƒ³ã‚¯ã‚’å¿…è¦æ™‚è¿½åŠ å¯ |
| **Cloud Monitoring** | ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ | ã—ãªã„ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯åé›†ã•ã‚Œã‚‹ã€‚ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒªã‚·ãƒ¼ãƒ»ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯æœªå®šç¾©ã€‚å¿…è¦æ™‚ Terraform ã§è¿½åŠ å¯ |

**å‡¡ä¾‹**
- **âœ… ã™ã‚‹**: ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆãƒ»æ›´æ–°ã‚’ Terraform ã§è¡Œã†
- **å®šç¾©ã®ã¿**: è¨­å®šã‚’ Terraform ã«æ›¸ããŒã€å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ CI ãªã©åˆ¥æ‰‹æ®µï¼ˆCloud Run ãŒè©²å½“ï¼‰
- **API æœ‰åŠ¹åŒ–ã®ã¿**: ãã® API ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã ã‘ã€‚ãƒªã‚½ãƒ¼ã‚¹æœ¬ä½“ã¯æœªç®¡ç†
- **ã—ãªã„**: ã“ã® IaC ã§ã¯ç®¡ç†ã—ãªã„ï¼ˆæ‰‹å‹•ãƒ»åˆ¥ãƒ„ãƒ¼ãƒ«ï¼‰

## ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã® Google Cloud ä¸Šã®æ§‹æˆã‚’ Mermaid ã§ç¤ºã—ã¾ã™ã€‚GitHub ã‚„ Mermaid å¯¾å¿œã® Markdown ãƒ“ãƒ¥ãƒ¼ã‚¢ã§å›³ã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å…¬å¼ã‚¢ã‚¤ã‚³ãƒ³ã§æãå ´åˆã¯ [Google Cloud ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ç”¨ã‚¢ã‚¤ã‚³ãƒ³](https://cloud.google.com/architecture/diagrams) ã‚„ [draw.io ã® GCP ã‚¢ã‚¤ã‚³ãƒ³ã‚»ãƒƒãƒˆ](https://www.drawio.com/blog/google-cloud-platform-icons/) ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚

```mermaid
flowchart LR
  subgraph external["å¤–éƒ¨"]
    User["ãƒ¦ãƒ¼ã‚¶ãƒ¼"]
    DNS["DNS (å¤–éƒ¨)"]
    MapsAPI["Maps API (Routes/Places)"]
  end

  subgraph gcp["Google Cloud"]
    subgraph edge["ã‚¨ãƒƒã‚¸"]
      LB["Global HTTP(S) LB"]
      Armor["Cloud Armor"]
      CDN["Cloud CDN"]
    end
    subgraph run["Cloud Run"]
      Web["web (Nuxt)"]
      Agent["agent (FastAPI)"]
      Ranker["ranker (FastAPI)"]
    end
    subgraph data["ãƒ‡ãƒ¼ã‚¿ãƒ»AI"]
      BQ["BigQuery"]
      VertexLLM["Vertex AI (Gemini)"]
      VertexEP["Vertex AI (ã‚«ã‚¹ã‚¿ãƒ  EP)"]
    end
  end

  User --> DNS --> LB --> Armor --> CDN --> Web
  Web --> Agent
  Agent --> Ranker
  Agent --> VertexLLM
  Agent --> BQ
  Agent --> MapsAPI
  Ranker --> VertexEP
```

- **ãƒ•ãƒ­ãƒ³ãƒˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ â†’ å¤–éƒ¨ DNS â†’ Global LB â†’ Cloud Armor â†’ Cloud CDN â†’ NEG â†’ Cloud Run **web**
- **API é€£æº**: **web** ãŒ **agent** ã‚’å‘¼ã³å‡ºã—ã€**agent** ãŒ Ranker / Vertex AIï¼ˆLLMï¼‰/ BigQuery / Maps API ã‚’åˆ©ç”¨ã€‚**ranker** ãŒ Vertex AI ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§æ¨è«–ã€‚

## æ§‹æˆ

```
infra/
â”œâ”€â”€ README.md           # æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â””â”€â”€ terraform/
    â”œâ”€â”€ main.tf          # ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€API æœ‰åŠ¹åŒ–
    â”œâ”€â”€ variables.tf    # å¤‰æ•°å®šç¾©
    â”œâ”€â”€ outputs.tf      # å‡ºåŠ›å€¤
    â”œâ”€â”€ artifact_registry.tf  # Artifact Registry ãƒªãƒã‚¸ãƒˆãƒª
    â”œâ”€â”€ bigquery.tf     # BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ
    â”œâ”€â”€ iam.tf           # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ IAM
    â”œâ”€â”€ cloud_run.tf     # Cloud Run å®šç¾©ï¼ˆå®Ÿç’°å¢ƒãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ CIï¼‰
    â”œâ”€â”€ backend.tf.example   # GCS ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾‹
    â””â”€â”€ terraform.tfvars.example  # å¤‰æ•°ä¾‹ï¼ˆtfvars ã¯ .gitignore æ¨å¥¨ï¼‰
```

## ä½¿ã„æ–¹

### 1. åˆå›æº–å‚™

```bash
cd infra/terraform
cp terraform.tfvars.example terraform.tfvars
# å¤‰æ›´ãŒå¿…è¦ãªã‚‚ã®ã ã‘ç·¨é›†ï¼ˆproject_id, region, ranker_service_url ãªã©ï¼‰
# Agent ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã¯ ranker_service_url ã‚’å¿…ãšè¨­å®šï¼ˆæœªè¨­å®šã ã¨ RANKER_URL ãŒç©ºã«ãªã‚‹ï¼‰

# æ—¢ã«æ‰‹å‹•ã§ agent-runtime-sa ã‚’ä½œæˆæ¸ˆã¿ã®å ´åˆã¯ã€Terraform ã§ SA ã‚’æ–°è¦ä½œæˆã›ãš IAM ã®ã¿ä»˜ä¸ã™ã‚‹
# create_agent_runtime_sa = false ã‚’ terraform.tfvars ã«è¿½åŠ 

# GCS ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä½¿ã†å ´åˆ
cp backend.tf.example backend.tf
# backend.tf ã® bucket åã‚’ç·¨é›†
```

### 2. å®Ÿè¡Œ

```bash
terraform init
terraform plan   # å¤‰æ›´å†…å®¹ã®ç¢ºèª
terraform apply  # é©ç”¨ï¼ˆyes ã§ç¢ºå®šï¼‰
```

### 3. çŠ¶æ…‹ã‚’ GCS ã«ç½®ãå ´åˆï¼ˆæ¨å¥¨ï¼‰

1. æ‰‹å‹•ã¾ãŸã¯åˆ¥ã® Terraform ã§ GCS ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆï¼ˆä¾‹: `firstdown-482704-tfstate`ï¼‰ã€‚
2. `backend.tf.example` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ `backend.tf` ã‚’ä½œæˆã—ã€`bucket` ã‚’ãã®ãƒã‚±ãƒƒãƒˆåã«å¤‰æ›´ã€‚
3. `terraform init` ã§ã€ŒMigrate state to backend?ã€ã¨å‡ºãŸã‚‰ `yes` ã§ç§»è¡Œã€‚

## ç®¡ç†å¯¾è±¡ã¨æœªç®¡ç†

| ãƒªã‚½ãƒ¼ã‚¹ | Terraform ã§ã®ç®¡ç† | å‚™è€ƒ |
|----------|---------------------|------|
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§åˆ©ç”¨ã™ã‚‹ API ã®æœ‰åŠ¹åŒ– | âœ… | Cloud Run, Artifact Registry, BigQuery, Vertex AI ãªã© |
| Artifact Registry ãƒªãƒã‚¸ãƒˆãƒª | âœ… | `agent-repo`, `ranker-repo` |
| BigQuery ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ | âœ… | `firstdown_mvp`ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ DDLï¼ˆ`ml/agent/bq/*.sql`ï¼‰ã§åˆ¥ç®¡ç†å¯ |
| ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»IAM | âœ… | Agent å®Ÿè¡Œç”¨ SA ãªã© |
| Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ | å®šç¾©ã®ã¿ï¼ˆä»»æ„ã§ apply å¯ï¼‰ | å®Ÿç’°å¢ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ `cloud_run.tf` ã«å®šç¾©ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ GitHub Actions ã® gcloud ã®ã¾ã¾ã€‚[ä¸‹è¨˜](#cloud-run-ã‚’-terraform-ã§ç®¡ç†ã™ã‚‹å ´åˆ) å‚ç…§ |
| Vertex AI Endpoint | ä»»æ„ | ãƒ©ãƒ³ã‚«ãƒ¼ç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã€‚å¿…è¦ãªã‚‰åˆ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§è¿½åŠ  |

## å¤‰æ•°ã®æ‰±ã„ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ©ç”¨æ™‚ï¼‰

| ç¨®åˆ¥ | ä¾‹ | æ‰±ã„ |
|------|-----|------|
| **å¤‰æ›´ã—ãŒã¡ãªã‚‚ã®ï¼ˆå¤–å‡ºã—ï¼‰** | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ IDãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã€ã‚µãƒ¼ãƒ“ã‚¹åã€Ranker URLã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ IDã€Artifact Registry åã€SA åã€FEATURES_VERSION / VERTEX_TEXT_MODEL / MODEL_VERSION / RANKER_VERSIONã€API ã‚­ãƒ¼ | `variables.tf` ã§å®šç¾©ã—ã€ç’°å¢ƒã”ã¨ã« `terraform.tfvars`ï¼ˆã¾ãŸã¯ç’°å¢ƒå¤‰æ•° `TF_VAR_*`ï¼‰ã§**ã“ã“ã ã‘å¤‰æ›´**ã™ã‚Œã°ã‚ˆã„ |
| **æ™®éçš„ãªã‚‚ã®ï¼ˆã‚³ãƒ¼ãƒ‰ã®ã¾ã¾ï¼‰** | timeoutãƒ»memoryãƒ»CPUãƒ»concurrencyãƒ»min/max instanceã€IAM ãƒ­ãƒ¼ãƒ«ï¼ˆrun.invoker, aiplatform.user, bigquery ç­‰ï¼‰ã€allUsers ãƒãƒªã‚·ãƒ¼ | `.tf` ã«ãã®ã¾ã¾è¨˜è¼‰ã€‚ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ§‹ç¯‰ã™ã‚‹ã¨ãã‚‚**ãã®ã¾ã¾ä½¿ãˆã‚‹** |

åˆå›ã¯ `terraform.tfvars.example` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ `terraform.tfvars` ã‚’ä½œæˆã—ã€`project_id`ãƒ»`ranker_service_url` ãªã©å¿…è¦ãªé …ç›®ã ã‘ç·¨é›†ã—ã¦ä½¿ã†ã€‚

## Cloud Run ã®å®šç¾©ã¨ãƒ‡ãƒ—ãƒ­ã‚¤

- **å®šç¾©**: `infra/terraform/cloud_run.tf` ã«å®Ÿç’°å¢ƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆtimeout=300/30ã€memoryã€cpuã€env ãªã©ï¼‰ã‚’åæ˜ ã—ãŸ `google_cloud_run_v2_service` ã‚’å®šç¾©æ¸ˆã¿ã€‚**è¨­å®šã®å‚ç…§ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**ã¨ã—ã¦åˆ©ç”¨ã™ã‚‹ã€‚
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: å¼•ãç¶šã **GitHub Actions ã® `gcloud run deploy`** ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ã€‚MAPS_API_KEY ç­‰ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯ CI ã® `--set-env-vars` ã‚„ Secret Manager ã§æ¸¡ã™æƒ³å®šï¼ˆTerraform ã«ã¯æŒãŸãªã„ï¼‰ã€‚

### Terraform ã§ Cloud Run ã‚’ã€Œä½œæˆãƒ»æ›´æ–°ã€ã™ã‚‹å ´åˆï¼ˆä»»æ„ï¼‰

- å¤‰æ•° `agent_image` / `ranker_image` ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ URL ã‚’æ¸¡ã—ã¦ `terraform apply` ã™ã‚‹ã¨ã€Terraform ãŒ Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆãƒ»æ›´æ–°ã™ã‚‹ã€‚
- å¤‰æ•°ã‚’ç©ºã®ã¾ã¾ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ã«ã™ã‚‹ã¨ã€Cloud Run ãƒªã‚½ãƒ¼ã‚¹ã¯ **ä½œæˆã•ã‚Œãªã„**ï¼ˆæ—¢ã« CI ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãã®ã¾ã¾åˆ©ç”¨ï¼‰ã€‚ãã®å ´åˆã§ã‚‚ `.tf` ã«ã¯å®Ÿç’°å¢ƒã¨åŒã˜è¨­å®šãŒæ›¸ã‹ã‚Œã¦ãŠã‚Šã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦å‚ç…§ã§ãã‚‹ã€‚

## ãƒªãƒ³ã‚¯

- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã® README](../README.md)
- [Terraform Google Provider](https://registry.terraform.io/providers/hashicorp/google/latest/docs)
